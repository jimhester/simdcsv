name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  # Check eligibility and determine review type
  eligibility:
    runs-on: ubuntu-latest
    outputs:
      eligible: ${{ steps.check.outputs.eligible }}
      review_type: ${{ steps.check.outputs.review_type }}
    steps:
      - name: Check PR eligibility
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Skip if draft
          if [ "${{ github.event.pull_request.draft }}" = "true" ]; then
            echo "eligible=false" >> $GITHUB_OUTPUT
            echo "Skipping: PR is a draft"
            exit 0
          fi

          # Check if Claude has reviewed this PR before
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          CLAUDE_COMMENTS=$(gh pr view ${{ github.event.pull_request.number }} \
            --repo ${{ github.repository }} \
            --json comments \
            --jq '.comments[] | select(.body | contains("Generated with [Claude Code]"))' 2>/dev/null)

          # Check if this specific commit was already reviewed
          if echo "$CLAUDE_COMMENTS" | grep -q "${HEAD_SHA}"; then
            echo "eligible=false" >> $GITHUB_OUTPUT
            echo "Skipping: Claude already reviewed commit ${HEAD_SHA}"
            exit 0
          fi

          echo "eligible=true" >> $GITHUB_OUTPUT

          # Determine review type: full (first review) or followup
          if [ -z "$CLAUDE_COMMENTS" ]; then
            echo "review_type=full" >> $GITHUB_OUTPUT
            echo "Review type: full (first review)"
          else
            echo "review_type=followup" >> $GITHUB_OUTPUT
            echo "Review type: followup (new commits since last review)"
          fi

  # === FULL REVIEW JOBS (first review only) ===

  # Parallel review job 1: Requirements compliance
  review-requirements:
    needs: eligibility
    if: needs.eligibility.outputs.eligible == 'true' && needs.eligibility.outputs.review_type == 'full'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - name: Review requirements compliance
        id: review
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR: #${{ github.event.pull_request.number }}

            Review this PR for REQUIREMENTS COMPLIANCE only. Check:
            1. Read all CLAUDE.md files (root + directories with modified files) - do changes follow the guidance?
            2. Get the PR description and any linked issue - do changes address what was requested?
            3. Read inline code comments in modified files - do changes comply with guidance in comments?

            Write your findings to a file at /tmp/requirements-issues.json as a JSON array.
            Each issue should have: "description", "source", "file", "line" (or null).
            If no issues, write: []
          claude_args: |
            --allowedTools "Read,Write,Glob,Grep,Bash(gh pr view:*),Bash(gh pr diff:*),Bash(gh issue view:*)"
      - name: Upload findings
        uses: actions/upload-artifact@v4
        with:
          name: requirements-issues
          path: /tmp/requirements-issues.json
          if-no-files-found: ignore

  # Parallel review job 2: Bug detection
  review-bugs:
    needs: eligibility
    if: needs.eligibility.outputs.eligible == 'true' && needs.eligibility.outputs.review_type == 'full'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - name: Review for bugs
        id: review
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR: #${{ github.event.pull_request.number }}

            Review this PR for BUGS only. Focus on:
            1. Get the PR diff and read the changed files
            2. Look for obvious bugs in the changed lines (not pre-existing issues)
            3. Check for logic errors, off-by-one, null pointer issues, resource leaks
            4. Check for security issues (injection, overflow, etc.)

            IGNORE:
            - Style/formatting issues (linters catch these)
            - Missing tests (unless CLAUDE.md requires them)
            - Pre-existing issues not introduced by this PR
            - Nitpicks a senior engineer wouldn't flag

            Write your findings to a file at /tmp/bug-issues.json as a JSON array.
            Each issue should have: "description", "source" (always "bug detection"), "file", "line".
            If no issues, write: []
          claude_args: |
            --allowedTools "Read,Write,Glob,Grep,Bash(gh pr view:*),Bash(gh pr diff:*)"
      - name: Upload findings
        uses: actions/upload-artifact@v4
        with:
          name: bug-issues
          path: /tmp/bug-issues.json
          if-no-files-found: ignore

  # Parallel review job 3: Historical context
  review-history:
    needs: eligibility
    if: needs.eligibility.outputs.eligible == 'true' && needs.eligibility.outputs.review_type == 'full'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git blame/log
      - name: Review historical context
        id: review
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR: #${{ github.event.pull_request.number }}

            Review this PR using HISTORICAL CONTEXT. Check:
            1. Use `git blame` and `git log` on modified files - are changes consistent with the code's history/intent?
            2. Search for previous PRs that touched these files - any relevant comments that apply here?
            3. Look for patterns that were intentionally established and might be broken

            Write your findings to a file at /tmp/history-issues.json as a JSON array.
            Each issue should have: "description", "source" (e.g., "git blame shows...", "PR #99 comment said..."), "file", "line" (or null).
            If no issues, write: []
          claude_args: |
            --allowedTools "Read,Write,Glob,Grep,Bash(git blame:*),Bash(git log:*),Bash(git show:*),Bash(gh pr list:*),Bash(gh pr view:*),Bash(gh pr diff:*),Bash(gh issue view:*)"
      - name: Upload findings
        uses: actions/upload-artifact@v4
        with:
          name: history-issues
          path: /tmp/history-issues.json
          if-no-files-found: ignore

  # Aggregation job: Score, filter, and post comment (full review only)
  aggregate:
    needs: [eligibility, review-requirements, review-bugs, review-history]
    if: always() && needs.eligibility.outputs.eligible == 'true' && needs.eligibility.outputs.review_type == 'full'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - name: Download all findings
        uses: actions/download-artifact@v4
        with:
          path: /tmp/findings
          merge-multiple: true
        continue-on-error: true
      - name: List downloaded files
        run: |
          echo "Downloaded findings:"
          ls -la /tmp/findings/ 2>/dev/null || echo "No findings directory"
          cat /tmp/findings/*.json 2>/dev/null || echo "No JSON files found"
      - name: Aggregate and post review
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR: #${{ github.event.pull_request.number }}
            COMMIT: ${{ github.event.pull_request.head.sha }}

            Aggregate code review findings and post a comment.

            First, read the JSON files from /tmp/findings/ directory (if they exist):
            - requirements-issues.json
            - bug-issues.json
            - history-issues.json

            For each issue found, assign a confidence score (0-100):
            - 0: False positive, doesn't hold up to scrutiny
            - 25: Might be real, but unverified
            - 50: Real but minor/nitpick
            - 75: Verified, impacts functionality
            - 100: Definitely real, will happen frequently

            ONLY include issues scoring 80+.

            Use `gh pr comment` to post in this exact format:

            ### Code review

            Found N issues:

            1. <description> (<source>)

            https://github.com/${{ github.repository }}/blob/${{ github.event.pull_request.head.sha }}/<file>#L<line-1>-L<line+1>

            ...

            Generated with [Claude Code](https://claude.ai/code)

            <sub>If useful, react with thumbs up. Otherwise, thumbs down.</sub>

            ---

            If no issues score 80+ (or no findings files exist), post:

            ### Code review

            No issues found. Checked for bugs and CLAUDE.md compliance.

            Generated with [Claude Code](https://claude.ai/code)
          claude_args: |
            --allowedTools "Read,Glob,Bash(ls:*),Bash(cat:*),Bash(gh pr comment:*),Bash(gh pr view:*),Bash(gh pr diff:*)"

  # === FOLLOWUP REVIEW (lightweight, for new commits) ===

  followup-review:
    needs: eligibility
    if: needs.eligibility.outputs.eligible == 'true' && needs.eligibility.outputs.review_type == 'followup'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - name: Lightweight followup review
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR: #${{ github.event.pull_request.number }}
            COMMIT: ${{ github.event.pull_request.head.sha }}

            This is a FOLLOWUP review - Claude has already reviewed this PR before.
            Focus only on NEW changes since the last review.

            1. Get the PR diff to see current changes
            2. Look for obvious bugs in the new/modified code
            3. Check if new changes still follow CLAUDE.md guidance

            IGNORE:
            - Issues already flagged in previous Claude reviews
            - Style/formatting (linters handle this)
            - Pre-existing code not modified in recent commits

            Use `gh pr comment` to post:

            ### Followup review

            <If issues found>
            Found N issues in new changes:

            1. <description>

            https://github.com/${{ github.repository }}/blob/${{ github.event.pull_request.head.sha }}/<file>#L<line>

            ...
            </If issues found>

            <If no issues>
            New changes look good. No issues found.
            </If no issues>

            Generated with [Claude Code](https://claude.ai/code)
          claude_args: |
            --allowedTools "Read,Glob,Grep,Bash(gh pr view:*),Bash(gh pr diff:*),Bash(gh pr comment:*),Bash(gh issue view:*)"

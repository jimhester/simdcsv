name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  # Check eligibility first (fast, prevents wasted parallel jobs)
  eligibility:
    runs-on: ubuntu-latest
    outputs:
      eligible: ${{ steps.check.outputs.eligible }}
    steps:
      - name: Check PR eligibility
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Skip if draft
          if [ "${{ github.event.pull_request.draft }}" = "true" ]; then
            echo "eligible=false" >> $GITHUB_OUTPUT
            echo "Skipping: PR is a draft"
            exit 0
          fi

          # Skip if already reviewed by Claude
          CLAUDE_COMMENTS=$(gh pr view ${{ github.event.pull_request.number }} \
            --repo ${{ github.repository }} \
            --json comments \
            --jq '.comments[] | select(.body | contains("Generated with [Claude Code]")) | .id' | wc -l)

          if [ "$CLAUDE_COMMENTS" -gt "0" ]; then
            echo "eligible=false" >> $GITHUB_OUTPUT
            echo "Skipping: Already reviewed by Claude"
            exit 0
          fi

          echo "eligible=true" >> $GITHUB_OUTPUT

  # Parallel review job 1: Requirements compliance
  review-requirements:
    needs: eligibility
    if: needs.eligibility.outputs.eligible == 'true'
    runs-on: ubuntu-latest
    outputs:
      issues: ${{ steps.review.outputs.result }}
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - name: Review requirements compliance
        id: review
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR: #${{ github.event.pull_request.number }}

            Review this PR for REQUIREMENTS COMPLIANCE only. Check:
            1. Read all CLAUDE.md files (root + directories with modified files) - do changes follow the guidance?
            2. Get the PR description and any linked issue - do changes address what was requested?
            3. Read inline code comments in modified files - do changes comply with guidance in comments?

            Return a JSON array of issues found. Each issue should have:
            - "description": brief description
            - "source": where the requirement came from (e.g., "CLAUDE.md", "issue #123", "code comment in foo.cpp:42")
            - "file": affected file path
            - "line": line number (if applicable, or null)

            If no issues, return: []

            IMPORTANT: Only return the JSON array, nothing else.
          claude_args: |
            --print
            --output-format json
            --max-turns 10
            --allowedTools "Read,Glob,Grep,Bash(gh pr view:*),Bash(gh pr diff:*),Bash(gh issue view:*)"

  # Parallel review job 2: Bug detection
  review-bugs:
    needs: eligibility
    if: needs.eligibility.outputs.eligible == 'true'
    runs-on: ubuntu-latest
    outputs:
      issues: ${{ steps.review.outputs.result }}
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - name: Review for bugs
        id: review
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR: #${{ github.event.pull_request.number }}

            Review this PR for BUGS only. Focus on:
            1. Get the PR diff and read the changed files
            2. Look for obvious bugs in the changed lines (not pre-existing issues)
            3. Check for logic errors, off-by-one, null pointer issues, resource leaks
            4. Check for security issues (injection, overflow, etc.)

            IGNORE:
            - Style/formatting issues (linters catch these)
            - Missing tests (unless CLAUDE.md requires them)
            - Pre-existing issues not introduced by this PR
            - Nitpicks a senior engineer wouldn't flag

            Return a JSON array of issues found. Each issue should have:
            - "description": brief description of the bug
            - "source": "bug detection"
            - "file": affected file path
            - "line": line number

            If no issues, return: []

            IMPORTANT: Only return the JSON array, nothing else.
          claude_args: |
            --print
            --output-format json
            --max-turns 10
            --allowedTools "Read,Glob,Grep,Bash(gh pr view:*),Bash(gh pr diff:*)"

  # Parallel review job 3: Historical context
  review-history:
    needs: eligibility
    if: needs.eligibility.outputs.eligible == 'true'
    runs-on: ubuntu-latest
    outputs:
      issues: ${{ steps.review.outputs.result }}
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git blame/log
      - name: Review historical context
        id: review
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR: #${{ github.event.pull_request.number }}

            Review this PR using HISTORICAL CONTEXT. Check:
            1. Use `git blame` and `git log` on modified files - are changes consistent with the code's history/intent?
            2. Search for previous PRs that touched these files - any relevant comments that apply here?
            3. Look for patterns that were intentionally established and might be broken

            Return a JSON array of issues found. Each issue should have:
            - "description": brief description
            - "source": historical context (e.g., "git blame shows...", "PR #99 comment said...")
            - "file": affected file path
            - "line": line number (if applicable, or null)

            If no issues, return: []

            IMPORTANT: Only return the JSON array, nothing else.
          claude_args: |
            --print
            --output-format json
            --max-turns 15
            --allowedTools "Read,Glob,Grep,Bash(git blame:*),Bash(git log:*),Bash(git show:*),Bash(gh pr list:*),Bash(gh pr view:*),Bash(gh pr diff:*)"

  # Aggregation job: Score, filter, and post comment
  aggregate:
    needs: [eligibility, review-requirements, review-bugs, review-history]
    if: always() && needs.eligibility.outputs.eligible == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
      - name: Aggregate and post review
        uses: anthropics/claude-code-action@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR: #${{ github.event.pull_request.number }}
            COMMIT: ${{ github.event.pull_request.head.sha }}

            Aggregate these code review findings and post a comment.

            REQUIREMENTS ISSUES (from review-requirements job):
            ${{ needs.review-requirements.outputs.issues }}

            BUG ISSUES (from review-bugs job):
            ${{ needs.review-bugs.outputs.issues }}

            HISTORICAL ISSUES (from review-history job):
            ${{ needs.review-history.outputs.issues }}

            For each issue from the inputs above, assign a confidence score (0-100):
            - 0: False positive, doesn't hold up to scrutiny
            - 25: Might be real, but unverified
            - 50: Real but minor/nitpick
            - 75: Verified, impacts functionality
            - 100: Definitely real, will happen frequently

            ONLY include issues scoring 80+.

            Use `gh pr comment` to post in this exact format:

            ### Code review

            Found N issues:

            1. <description> (<source>)

            https://github.com/${{ github.repository }}/blob/${{ github.event.pull_request.head.sha }}/<file>#L<line-1>-L<line+1>

            ...

            Generated with [Claude Code](https://claude.ai/code)

            <sub>If useful, react with thumbs up. Otherwise, thumbs down.</sub>

            ---

            If no issues score 80+, post:

            ### Code review

            No issues found. Checked for bugs and CLAUDE.md compliance.

            Generated with [Claude Code](https://claude.ai/code)
          claude_args: |
            --max-turns 5
            --allowedTools "Bash(gh pr comment:*),Bash(gh pr view:*)"

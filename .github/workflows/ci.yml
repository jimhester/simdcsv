name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test:
    name: ${{ matrix.os }} - ${{ matrix.build_type }}
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        build_type: [Release, Debug]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential

    - name: Install dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install cmake

    - name: Configure CMake
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}

    - name: Build
      run: |
        cmake --build build --config ${{ matrix.build_type }}

    - name: Run well-formed CSV tests
      run: |
        ./build/simdcsv_test

    - name: Run error handling tests
      run: |
        ./build/error_handling_test

    - name: Run all tests with CTest
      run: |
        cd build && ctest --output-on-failure --build-config ${{ matrix.build_type }}

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential lcov

    - name: Configure CMake with coverage
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Debug -DENABLE_COVERAGE=ON

    - name: Build with coverage
      run: |
        cmake --build build

    - name: Run tests
      run: |
        cd build && ctest --output-on-failure

    - name: Generate coverage info
      run: |
        cd build
        # Capture coverage using the config file from repo root
        lcov --config-file ../.lcovrc --capture --directory . --output-file coverage.info --ignore-errors mismatch,unused
        # Remove test, benchmark, and external dependencies from coverage
        lcov --config-file ../.lcovrc --remove coverage.info '*/test/*' '*/benchmark/*' '*/build/_deps/*' '/usr/*' --output-file coverage.info --ignore-errors unused
        # Show what files remain in the coverage report
        echo "=== Files in final coverage report ==="
        lcov --list coverage.info
        echo "=== Verifying no test/benchmark files remain ==="
        if grep -E "^SF:.*/test/|^SF:.*/benchmark/" coverage.info; then
          echo "ERROR: test or benchmark files found in coverage report!"
          exit 1
        else
          echo "OK: No test or benchmark files in coverage report"
        fi

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      if: github.repository == 'jimhester/simdcsv'
      continue-on-error: true
      with:
        files: ./build/coverage.info
        fail_ci_if_error: false
        verbose: true
        token: ${{ secrets.CODECOV_TOKEN }}

  minimal-release-build:
    name: Minimal Release Build
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential

    - name: Configure minimal release build
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTING=OFF -DBUILD_BENCHMARKS=OFF

    - name: Build
      run: |
        cmake --build build --config Release

    - name: Verify expected artifacts exist
      run: |
        echo "Checking for library..."
        if ls build/libsimdcsv_lib.* 1>/dev/null 2>&1; then
          echo "✓ Library found:"
          ls -la build/libsimdcsv_lib.*
        else
          echo "✗ Library not found!"
          exit 1
        fi

        echo "Checking for scsv binary..."
        if [ -f build/scsv ]; then
          echo "✓ scsv binary found:"
          ls -la build/scsv
        else
          echo "✗ scsv binary not found!"
          exit 1
        fi

    - name: Verify test executables are NOT built
      run: |
        echo "Verifying test executables are not present..."
        TEST_EXECUTABLES="simdcsv_test error_handling_test csv_parsing_test csv_parser_errors_test csv_extended_test dialect_detection_test type_detection_test c_api_test debug_test api_test quote_mask_test value_extraction_test streaming_test branchless_test simd_number_parsing_test io_util_test cli_test two_pass_coverage_test"

        FOUND_TESTS=""
        for test in $TEST_EXECUTABLES; do
          if [ -f "build/$test" ]; then
            FOUND_TESTS="$FOUND_TESTS $test"
          fi
        done

        if [ -n "$FOUND_TESTS" ]; then
          echo "✗ Test executables were built but should not have been:$FOUND_TESTS"
          exit 1
        fi
        echo "✓ No test executables found (as expected)"

    - name: Verify benchmark executables are NOT built
      run: |
        echo "Verifying benchmark executables are not present..."
        BENCHMARK_EXECUTABLES="simdcsv_benchmark quote_mask_benchmark"

        FOUND_BENCHMARKS=""
        for bench in $BENCHMARK_EXECUTABLES; do
          if [ -f "build/$bench" ]; then
            FOUND_BENCHMARKS="$FOUND_BENCHMARKS $bench"
          fi
        done

        if [ -n "$FOUND_BENCHMARKS" ]; then
          echo "✗ Benchmark executables were built but should not have been:$FOUND_BENCHMARKS"
          exit 1
        fi
        echo "✓ No benchmark executables found (as expected)"

  shared-library-build:
    name: Shared Library Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential

    - name: Install dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install cmake

    - name: Configure shared library build
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=ON

    - name: Build
      run: |
        cmake --build build --config Release

    - name: Verify shared library exists (Linux)
      if: runner.os == 'Linux'
      run: |
        echo "Checking for shared library (.so)..."
        if ls build/libsimdcsv_lib.so* 1>/dev/null 2>&1; then
          echo "✓ Shared library found:"
          ls -la build/libsimdcsv_lib.so*
        else
          echo "✗ Shared library not found!"
          ls -la build/
          exit 1
        fi

    - name: Verify shared library exists (macOS)
      if: runner.os == 'macOS'
      run: |
        echo "Checking for shared library (.dylib)..."
        if ls build/libsimdcsv_lib.dylib* 1>/dev/null 2>&1; then
          echo "✓ Shared library found:"
          ls -la build/libsimdcsv_lib.dylib*
        else
          echo "✗ Shared library not found!"
          ls -la build/
          exit 1
        fi

    - name: Verify scsv binary exists and links correctly
      run: |
        echo "Checking for scsv binary..."
        if [ -f build/scsv ]; then
          echo "✓ scsv binary found:"
          ls -la build/scsv
        else
          echo "✗ scsv binary not found!"
          exit 1
        fi

    - name: Test scsv can execute (Linux)
      if: runner.os == 'Linux'
      run: |
        echo "Testing scsv execution with LD_LIBRARY_PATH..."
        export LD_LIBRARY_PATH="${PWD}/build:${LD_LIBRARY_PATH}"
        ./build/scsv --help

    - name: Test scsv can execute (macOS)
      if: runner.os == 'macOS'
      run: |
        echo "Testing scsv execution..."
        ./build/scsv --help

  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check file structure
      run: |
        echo "Checking required files..."
        test -f CMakeLists.txt || exit 1
        test -f include/error.h || exit 1
        test -f src/error.cpp || exit 1
        test -d test/data || exit 1
        echo "✓ All required files present"

    - name: Count test files
      run: |
        echo "Well-formed CSV test files:"
        find test/data -name "*.csv" ! -path "*/malformed/*" | wc -l
        echo "Malformed CSV test files:"
        find test/data/malformed -name "*.csv" | wc -l
        echo "Total test files:"
        find test/data -name "*.csv" | wc -l

    - name: Verify test file integrity
      run: |
        # Check that malformed test files exist
        MALFORMED_COUNT=$(find test/data/malformed -name "*.csv" | wc -l)
        if [ "$MALFORMED_COUNT" -lt 16 ]; then
          echo "Error: Expected at least 16 malformed test files, found $MALFORMED_COUNT"
          exit 1
        fi
        echo "✓ Found $MALFORMED_COUNT malformed test files"

name: Performance Regression Check

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  pull-requests: write

jobs:
  benchmark:
    name: Performance Regression Detection
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake build-essential

    - name: Configure CMake (Release)
      run: |
        cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build benchmark
      run: |
        cmake --build build --target libvroom_benchmark --config Release

    - name: Run quick benchmark
      timeout-minutes: 5
      run: |
        # Run only specific benchmarks with limited iterations for speed
        # Filter to run essential benchmarks only, with JSON output for comparison
        # Benchmark names defined in benchmark/basic_benchmarks.cpp
        cd build
        ./libvroom_benchmark \
          --benchmark_filter="BM_ParseSimple_Threads/1|BM_ParseManyRows_Threads/1|BM_ParseQuoted/1" \
          --benchmark_repetitions=3 \
          --benchmark_min_time=0.1s \
          --benchmark_out=benchmark_results.json \
          --benchmark_out_format=json

    - name: Download previous benchmark results
      uses: actions/cache/restore@v4
      id: cache-benchmark
      with:
        path: baseline_benchmark.json
        key: benchmark-baseline-${{ runner.os }}-main
        restore-keys: |
          benchmark-baseline-${{ runner.os }}-main

    - name: Compare benchmarks and detect regression
      id: compare
      run: python3 benchmark/check_regression.py

    - name: Save baseline for future runs
      uses: actions/cache/save@v4
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      with:
        path: baseline_benchmark.json
        key: benchmark-baseline-${{ runner.os }}-main

    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: benchmark-results
        path: |
          build/benchmark_results.json
          baseline_benchmark.json
        retention-days: 30
